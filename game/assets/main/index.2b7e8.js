window.__require=function t(e,n,i){function o(r,c){if(!n[r]){if(!e[r]){var s=r.split("/");if(s=s[s.length-1],!e[s]){var l="function"==typeof __require&&__require;if(!c&&l)return l(s,!0);if(a)return a(s,!0);throw new Error("Cannot find module '"+r+"'")}r=s}var d=n[r]={exports:{}};e[r][0].call(d.exports,function(t){return o(e[r][1][t]||t)},d,d.exports,t,e,n,i)}return n[r].exports}for(var a="function"==typeof __require&&__require,r=0;r<i.length;r++)o(i[r]);return o}({HelloTest:[function(t,e,n){"use strict";cc._RF.push(e,"d122aQAhcVGeZH7G1VChRJR","HelloTest");var i,o=this&&this.__extends||(i=function(t,e){return(i=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}i(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),a=this&&this.__decorate||function(t,e,n,i){var o,a=arguments.length,r=a<3?e:null===i?i=Object.getOwnPropertyDescriptor(e,n):i;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,n,i);else for(var c=t.length-1;c>=0;c--)(o=t[c])&&(r=(a<3?o(r):a>3?o(e,n,r):o(e,n))||r);return a>3&&r&&Object.defineProperty(e,n,r),r};Object.defineProperty(n,"__esModule",{value:!0});var r=cc._decorator,c=r.ccclass,s=r.property,l=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.NpcNode=null,e.fileListNode=null,e.animListNode=null,e.scaleLable=null,e.slider=null,e.file={},e.selectDB=null,e.url="http://127.0.0.1:8888/npc",e}return o(e,t),e.prototype.onLoad=function(){var t=this,e=new XMLHttpRequest;e.open("get",this.url,!0),e.onreadystatechange=function(){if(4==e.readyState&&200==e.status){var n=JSON.parse(e.responseText);console.log("data--1>",n),t.showNpcInfo(n)}},e.send(null),this.NpcNode.on(cc.Node.EventType.TOUCH_MOVE,this.touchMove,this),this.NpcNode.on(cc.Node.EventType.TOUCH_CANCEL,this.touchEnd,this),this.NpcNode.on(cc.Node.EventType.TOUCH_END,this.touchEnd,this)},e.prototype.touchMove=function(t){this.NpcNode.x+=t.getDeltaX(),this.NpcNode.y+=t.getDeltaY()},e.prototype.touchEnd=function(){this.NpcNode.x>=667&&(this.NpcNode.x=667),this.NpcNode.x<=-268&&(this.NpcNode.x=-268),this.NpcNode.y>=375&&(this.NpcNode.y=375),this.NpcNode.y<=-375&&(this.NpcNode.y=-375)},e.prototype.showNpcInfo=function(t){var e=this;Object.keys(t).forEach(function(n){e.addFileList(n,t[n]);var i=t[n].texture,o=t[n].ske,a=t[n].tex;e.showOnceNpc(i,o,a)})},e.prototype.addFileList=function(t,e){this.file[t]=e,this.updateFileList()},e.prototype.updateFileList=function(){var t=this;this.fileListNode.removeAllChildren(),Object.keys(this.file).forEach(function(e){var n=t.newNodeLabelItem(e);n.on(cc.Node.EventType.TOUCH_END,function(){var n=t.file[e].texture,i=t.file[e].ske,o=t.file[e].tex;t.showOnceNpc(n,i,o)},t),n.parent=t.fileListNode})},e.prototype.newNodeLabelItem=function(t){var e=new cc.Node,n=e.addComponent(cc.Label);return n.string=t,n.fontSize=20,e},e.prototype.showAnimList=function(t){var e=this,n=t.getAnimationNames("Armature");this.animListNode.removeAllChildren(),n.forEach(function(n){var i=e.newNodeLabelItem(n);i.on(cc.Node.EventType.TOUCH_END,function(){t.playAnimation(n,-1)},e),i.parent=e.animListNode})},e.prototype.showOnceNpc=function(t,e,n){var i=this;cc.log(t,e,n),this.NpcNode.scale=1,this.slider.progress=.5,this.scaleLable.string="1.00";var o=this.NpcNode.addComponent(dragonBones.ArmatureDisplay),a="http://127.0.0.1:8888/",r=a+t,c=a+n,s=a+e;cc.loader.load(r,function(t,e){cc.loader.load({url:c,type:"txt"},function(t,n){cc.loader.load({url:s,type:"txt"},function(t,a){var r=new dragonBones.DragonBonesAtlasAsset;r.atlasJson=n,r.texture=e;var c=new dragonBones.DragonBonesAsset;c.dragonBonesJson=a,o.dragonAtlasAsset=r,o.dragonAsset=c,o.armatureName="Armature",o.playAnimation("act_stand",0),i.showAnimList(o)})})})},e.prototype.progress=function(t){var e=.5+t.progress;this.NpcNode.scale=e,this.scaleLable.string=e.toFixed(2)},a([s(cc.Node)],e.prototype,"NpcNode",void 0),a([s(cc.Node)],e.prototype,"fileListNode",void 0),a([s(cc.Node)],e.prototype,"animListNode",void 0),a([s(cc.Label)],e.prototype,"scaleLable",void 0),a([s(cc.Slider)],e.prototype,"slider",void 0),a([c],e)}(cc.Component);n.default=l,cc._RF.pop()},{}],NpcBuilder:[function(t,e){"use strict";cc._RF.push(e,"f9b53kOKnJJV6nYwl03KiYl","NpcBuilder");var n={},i=function(){function t(t){var e=this;for(var n in this.id=void 0,this.npc_id=void 0,this.npc_tag=void 0,this.name=void 0,this.node=void 0,this.ctrl=void 0,this.animation=void 0,this.props=void 0,this.scale=void 0,this.init_act=void 0,this.init_turn=void 0,this.tacitly_act=void 0,this.hit_test=void 0,this.is_touch=void 0,t.name="npc_"+t.npc_id,this.node=new cc.Node,t)t.hasOwnProperty(n)&&(n in this.node&&(this.node[n]=t[n]),this.hasOwnProperty(n)&&(this[n]=t[n]));if(this.is_touch){var i=0;this.node.on(cc.Node.EventType.TOUCH_START,function(){i=(new Date).getTime()},this),this.node.on(cc.Node.EventType.TOUCH_END,function(){if((new Date).getTime()-i<300){var t=new cc.Event.EventCustom("ON_NPC_CLICK",!0);t.detail=e,e.node.dispatchEvent(t)}},this)}}var e=t.prototype;return e.play=function(t,e,n){return void 0===e&&(e=0),void 0===n&&(n=!0),cc.aha.Utils.debugLog("\u9f99\u9aa8\u6267\u884c\u52a8\u4f5c\uff1a",t,e,n),e=Number(e),cc.aha.Utils.isAllowKey(t)?this.animation instanceof dragonBones.Animation?this.animation.hasAnimation(t)?((!1===this.node.active||e<=0)&&this.node.emit("ON_NPC_PLAY_COMPLETE",{action:t,time:e}),n?this.animation.fadeIn(t,.4,e):this.animation.play(t,e)):(cc.warn("npc "+this.id+" play error: "+t+" \u4e0d\u5b58\u5728, \u5168\u90e8\uff1a",this.animation.animationNames),this.node.emit("ON_NPC_PLAY_COMPLETE",{action:t,time:e})):this.ctrl instanceof dragonBones.ArmatureDisplay?((!1===this.node.active||e<=0)&&this.node.emit("ON_NPC_PLAY_COMPLETE",{action:t,time:e}),this.ctrl.playAnimation(t,e)):(cc.warn("npc "+this.id+" play error: NPC\u975e\u9f99\u9aa8"),this.node.emit("ON_NPC_PLAY_COMPLETE",{action:t,time:e})):(cc.warn("npc "+this.id+" play error: \u4e0d\u652f\u6301\u4e2d\u6587 "+t),this.node.emit("ON_NPC_PLAY_COMPLETE",{action:t,time:e}))},e.stop=function(t){if(void 0===t&&(t=null),cc.aha.Utils.debugLog("\u9f99\u9aa8\u6682\u505c\u52a8\u4f5c"),this.animation instanceof dragonBones.Animation)return this.animation.stop(t)},e.defAct=function(){if(cc.aha.Utils.debugLog("\u9f99\u9aa8\u6062\u590d\u9ed8\u8ba4\u52a8\u4f5c"),this.animation instanceof dragonBones.Animation)return this.init_act&&cc.aha.Utils.isAllowKey(this.init_act)?this.animation.hasAnimation(this.init_act)?this.play(this.init_act):(cc.warn("npc "+this.id+" play def error: init_act:"+this.init_act+" \u4e3a\u7a7a"),this.stop()):this.stop()},e.plist=function(t,e){void 0===e&&(e="plist"),cc.aha.Utils.debugLog("\u9f99\u9aa8\u64ad\u653e\u7c92\u5b50\uff1a",t,e);var n=null;if(t){var i=cc.aha.Resource.plist(t);(n=JSON.parse(i)).textureFileName=null}if(this.ctrl&&this.ctrl.attachUtil&&e)for(var o=this.ctrl.attachUtil.generateAttachedNodes(e)||[],r=0;r<o.length;r++){var c=o[r];if(c.destroyAllChildren(),n){var s=new cc.Node;s.name="plist_"+t,s.scale=this.node.scale,a(s,n),c.addChild(s)}}},e.effect=function(t,e,n){var i=this;void 0===e&&(e={x:0,y:0}),void 0===n&&(n=1),cc.aha.Utils.debugLog("\u9f99\u9aa8\u64ad\u653e\u7279\u6548\uff1a",t,e,n),n=Number(n);var o=cc.aha.Resource.effect(t);if(o.pic&&o.tex&&o.ske){var a=new cc.Node;a.name="effect_"+t,a.once("ON_NPC_PLAY_COMPLETE",function(){a.destroy(),i.node.emit("ON_NPC_EFFECT_COMPLETE")});var c=r(a,o,!1).ctrl,s=e.x-this.node.anchorX,l=e.y-this.node.anchorY;a.x=this.node.width*s,a.y=this.node.height*l;var d=this.node.scaleY/(this.scale*this.scale);a.scaleX=this.node.scaleX<0?-d:d,a.scaleY=d,a.parent=this.node;var p=c.getArmatureNames();if(p[0]){var h=c.getAnimationNames(p[0]);h[0]&&cc.aha.Utils.isAllowKey(h[0])?c.playAnimation(h[0],n):(a.destroy(),cc.warn("\u4e0d\u652f\u6301\u4e2d\u6587 "+h[0]),this.node.emit("ON_NPC_EFFECT_COMPLETE"))}else a.destroy(),this.node.emit("ON_NPC_EFFECT_COMPLETE")}},t}();function o(t,e,n){n=n||!1;var i=t.addComponent(cc.Sprite);return n&&(e.setPremultiplyAlpha(!0),i.srcBlendFactor=cc.macro.BlendFactor.ONE),i.spriteFrame=new cc.SpriteFrame(e),{node:t}}function a(t,e){var n=t.addComponent(cc.ParticleSystem);return n._plistFile="https://aharesource-bucket.ahaschool.com.cn/game",n._initWithDictionary(e),{node:t}}function r(t,e,i){i=i||!1;var o=t.addComponent(dragonBones.ArmatureDisplay);i&&(o.premultipliedAlpha=!0,e.pic.setPremultiplyAlpha(!0));var a=new dragonBones.DragonBonesAtlasAsset,r=new dragonBones.DragonBonesAsset;a.texture=e.pic,a.atlasJson=e.tex.text,r.dragonBonesJson=e.ske.text,o.dragonAsset=r,o.dragonAtlasAsset=a,o.armatureName="Armature";var c="db_tex_"+a._uuid,s="db_ske_"+r._uuid,l=n[c]||0,d=n[s]||0;l+=1,d+=1,n[c]=l,n[s]=d,o.onDestroy=function(){var t=n[c]||0,e=n[s]||0;t=t<=1?0:t-1,e=e<=1?0:e-1,n[c]=t,n[s]=e,t<=0&&a.destroy(),e<=0&&r.destroy()},o.addEventListener(dragonBones.EventObject.COMPLETE,function(e){t.emit("ON_NPC_PLAY_COMPLETE",e)},this);var p=o,h=o.getArmatureNames(),u=null;if(h[0]){o.armatureName=h[0];var f=o.armature();f&&f.animation&&(u=f.animation);var _=f.armatureData.aabb;_&&(t.width=_.width,t.height=_.height)}return{node:t,ctrl:p,animation:u}}e.exports={newEffect:function(t,e,n){void 0===n&&(n=!0);var i=t.parent,o=t.effect_id,a=t.act_time,c=cc.aha.Resource.effect(o);if(!c.pic||!c.tex||!c.ske)return e&&e("EFFECT_RES_ERROR");var s=new cc.Node;s.name="effect_"+o,s.once("ON_NPC_PLAY_COMPLETE",function(){s.emit("ON_NPC_EFFECT_COMPLETE"),n&&s.destroy()});var l=r(s,c,!1).ctrl;s.parent=i;var d=l.getArmatureNames();if(d[0]){var p=l.getAnimationNames(d[0]);return p[0]&&cc.aha.Utils.isAllowKey(p[0])?(l.playAnimation(p[0],a),e&&e(null,s)):(n&&s.destroy(),cc.warn("\u4e0d\u652f\u6301\u4e2d\u6587 "+p[0]),e&&e("ACT_NAME_ERROR"))}return n&&s.destroy(),e&&e("EFFECT_NAME_ERROR")},newNpc:function(t){var e,n,i=this;cc.aha.Utils.debugLog("\u6784\u5efaNPC\uff1a",t),1==(arguments.length<=1?0:arguments.length-1)?n=arguments.length<=1?void 0:arguments[1]:(e=arguments.length<=1?void 0:arguments[1],n=arguments.length<=2?void 0:arguments[2]),t instanceof Array?function(){for(var o=[],a=0;a<t.length;a++)i.npcTask(t[a],function(i,a){if(!i&&(o.push(a),e&&e(o.length,t.length,a),o.length>=t.length&&n))return n(null,o)})}():this.npcTask(t,n)},releaseNpc:function(t){if(cc.aha.Utils.debugLog("\u91ca\u653eNPC\uff1a",t),t instanceof i)t.destroy();else if(t instanceof Array)for(var e=t.length-1;e>=0;e--)t[e].destroy()},npcTask:function(t,e){var n={id:0,npc_id:0,npc_tag:"def",npc_res:null,scale:1,width:500,height:500,anchorX:.5,anchorY:0,zIndex:0,props:{},parent:null,init_act:"",init_turn:1,tacitly_act:"",hit_test:!1,is_touch:!1,pre_alpha:!1,position:{x:0,y:0}};if(!(t instanceof Object)){var a=new Error("\u5144\u5f1f\uff01\u4f60\u4f20\u8fc7\u6765\u7684\u521d\u59cb\u5316\u53c2\u6570\u4e0d\u5bf9\u54e6\uff01");return cc.error(a),void(e&&e(a))}for(var c in t)t.hasOwnProperty(c)&&n.hasOwnProperty(c)&&(n[c]=t[c]);var s={pic:null,tex:null,ske:null};if(n.npc_id){var l=cc.aha.Resource.get(n.npc_id);l&&l._asset&&("npc"===l._type?(s.pic=l._asset.pic,s.tex=l._asset.tex,s.ske=l._asset.ske):"image"===l._type&&(s.pic=l._asset))}else n.npc_res&&(s.pic=n.npc_res.pic,s.tex=n.npc_res.tex,s.ske=n.npc_res.ske);if(!s||!s.pic){var d=new Error("\u5144\u5f1f\uff01\u4f60\u4f20\u8fc7\u6765\u7684NPC\u4e0d\u5b58\u5728\uff01");return cc.error(d,n),void(e&&e(d))}var p=new RegExp(/^https:\/\//),h={load_npc_pic:function(t){if("string"!=typeof s.pic||!p.test(s.pic)){if(s.pic instanceof cc.Texture2D)return t(null,s.pic);var e=new Error("\u5927\u54e5\uff01\u4ed4\u7ec6\u68c0\u67e5\u4e00\u4e0b\u6570\u636e\u914d\u7f6e\uff01\u56fe\u7247\u5730\u5740\u4e0d\u5bf9\uff01");return cc.error(e),t(e)}cc.assetManager.loadRemote(s.pic,{ext:".png"},function(e,n){return t(e,n)})},load_npc_tex:function(t){if("string"!=typeof s.tex||!p.test(s.tex))return s.tex instanceof cc.TextAsset?t(null,s.tex):t(null,null);cc.assetManager.loadRemote(s.tex,{ext:".txt"},function(e,n){return t(e,n)})},load_npc_ske:function(t){if("string"!=typeof s.ske||!p.test(s.ske))return s.ske instanceof cc.TextAsset?t(null,s.ske):t(null,null);cc.assetManager.loadRemote(s.ske,{ext:".txt"},function(e,n){return t(e,n)})}};cc.aha.Utils.asyncTasks(h,function(t,a){var c=new i(n),s={pic:a.load_npc_pic,tex:a.load_npc_tex,ske:a.load_npc_ske};if(s.pic&&s.tex&&s.ske){var l=r(c.node,s,n.pre_alpha),d=l.ctrl,p=l.animation;return c.ctrl=d,c.animation=p,c.defAct(),e&&e(null,c)}if(s.pic){var h=s.pic;return o(c.node,h,n.pre_alpha),e&&e(null,c)}return e&&e("npc build task error",s)})}},cc._RF.pop()},{}],Npc:[function(t,e){"use strict";cc._RF.push(e,"450e8ykKGdF6a9CeHGa6ACo","Npc"),cc._RF.pop()},{}]},{},["HelloTest","Npc","NpcBuilder"]);